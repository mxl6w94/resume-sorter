import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, addDoc, getDocs, writeBatch, query } from 'firebase/firestore';

// --- Icon Components (Lucide React SVGs) ---
const Icon = ({ children, className = '', size = 24 }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width={size}
    height={size}
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={className}
  >
    {children}
  </svg>
);

const ChevronDown = (props) => <Icon {...props}><polyline points="6 9 12 15 18 9"></polyline></Icon>;
const ChevronUp = (props) => <Icon {...props}><polyline points="18 15 12 9 6 15"></polyline></Icon>;
const PlusCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></Icon>;
const Edit2 = (props) => <Icon {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></Icon>;
const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13H7v8"></polyline><polyline points="7 3 7 8H15"></polyline></Icon>;
const XCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></Icon>;
const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></Icon>;
const Zap = (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></Icon>;
const Loader2 = (props) => <Icon {...props} className={`animate-spin ${props.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></Icon>;
const KeyRound = (props) => <Icon {...props}><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"></path><circle cx="16.5" cy="7.5" r=".5"></circle></Icon>;
const Users = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;


// --- Initial Data (used as a fallback if Firestore is empty) ---
const initialApplicants = [
  { id: '1', name: 'Alice Wonderland', email: 'alice@example.com', skillsScore: 8, yearsExperience: 5, educationLevel: 'Master', interviewScore: 0, notes: 'Strong portfolio in UI/UX.' },
  { id: '2', name: 'Bob The Builder', email: 'bob@example.com', skillsScore: 6, yearsExperience: 10, educationLevel: 'Bachelor', interviewScore: 0, notes: 'Extensive backend experience.' },
];

const initialCriteria = [
  { id: 'skillsScore', name: 'Relevant Skills Score (0-10)', weight: 0.40, type: 'numeric', maxScore: 10 },
  { id: 'yearsExperience', name: 'Years of Experience', weight: 0.25, type: 'numeric_map', map: [{years:0, score:2}, {years:2, score:5}, {years:5, score:8}, {years:10, score:10}], maxScore: 10 },
  { id: 'educationLevel', name: 'Education Level', weight: 0.20, type: 'categorical_map', map: { 'N/A': 0, 'High School': 2, 'Associate': 4, 'Bachelor': 7, 'Master': 9, 'PhD': 10 }, maxScore: 10 },
  { id: 'interviewScore', name: 'Interview Score (0-10)', weight: 0.15, type: 'numeric', maxScore: 10 },
];

const educationLevels = ['N/A', 'High School', 'Associate', 'Bachelor', 'Master', 'PhD'];
const generateId = () => Math.random().toString(36).substr(2, 9);

// --- Main Application Component ---
function App() {
  // Firebase state
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  // App-specific state
  const [applicants, setApplicants] = useState([]);
  const [rankingCriteria, setRankingCriteria] = useState([]);
  const [editingApplicant, setEditingApplicant] = useState(null);
  const [showApplicantForm, setShowApplicantForm] = useState(false);
  const [showCriteriaConfig, setShowCriteriaConfig] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  // --- Firebase Initialization and Auth ---
  useEffect(() => {
    try {
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
      if (!firebaseConfig) {
          setError("Firebase configuration is missing.");
          setIsLoading(false);
          return;
      }
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);
      setDb(firestore);
      setAuth(authInstance);

      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(authInstance, __initial_auth_token);
            } else {
              await signInAnonymously(authInstance);
            }
          } catch (authError) {
            console.error("Authentication Error:", authError);
            setError("Failed to authenticate. Please refresh the page.");
          }
        }
        setIsAuthReady(true);
      });
      return () => unsubscribe();
    } catch (e) {
      console.error("Firebase Init Error:", e);
      setError("Failed to initialize the application. Check console for details.");
      setIsLoading(false);
    }
  }, []);

  // --- Firestore Data Fetching ---
  useEffect(() => {
    if (!isAuthReady || !db) return;

    setIsLoading(true);
    const applicantsPath = `artifacts/${appId}/public/data/applicants`;
    const criteriaPath = `artifacts/${appId}/public/data/criteria`;

    const applicantsQuery = query(collection(db, applicantsPath));
    const criteriaQuery = query(collection(db, criteriaPath));

    const unsubApplicants = onSnapshot(applicantsQuery, (snapshot) => {
      const applicantsList = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      setApplicants(applicantsList);
      setIsLoading(false);
    }, (err) => {
      console.error("Error fetching applicants:", err);
      setError("Could not load applicant data.");
      setIsLoading(false);
    });

    const unsubCriteria = onSnapshot(criteriaQuery, async (snapshot) => {
      let criteriaList = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      if (criteriaList.length === 0) {
        // If no criteria in Firestore, populate with initial data
        console.log("No criteria found in Firestore, seeding with initial data...");
        const batch = writeBatch(db);
        initialCriteria.forEach(crit => {
            const docRef = doc(db, criteriaPath, crit.id);
            batch.set(docRef, crit);
        });
        await batch.commit();
        setRankingCriteria(initialCriteria);
      } else {
        setRankingCriteria(criteriaList);
      }
    }, (err) => {
      console.error("Error fetching criteria:", err);
      setError("Could not load ranking criteria.");
    });

    return () => {
      unsubApplicants();
      unsubCriteria();
    };
  }, [isAuthReady, db, appId]);

  // --- Core Logic ---
  const calculateScore = useCallback((applicant) => {
    if (rankingCriteria.length === 0) return 0;
    let totalScore = 0;
    let maxPossibleScoreWeighted = 0;

    rankingCriteria.forEach(criterion => {
      let value = applicant[criterion.id];
      let criterionScore = 0;
      if (value === undefined || value === null) value = 0;
      
      if (criterion.type === 'numeric') {
        criterionScore = Math.min(parseFloat(value) || 0, criterion.maxScore);
      } else if (criterion.type === 'categorical_map' && criterion.map) {
        criterionScore = criterion.map[value] || 0;
      } else if (criterion.type === 'numeric_map' && criterion.map) {
        let mappedScore = 0;
        const sortedMap = [...criterion.map].sort((a,b) => a.years - b.years);
        for (let i = sortedMap.length - 1; i >= 0; i--) {
          if (parseFloat(value) >= sortedMap[i].years) {
            mappedScore = sortedMap[i].score;
            break;
          }
        }
        criterionScore = mappedScore;
      }
      totalScore += (criterionScore / criterion.maxScore) * criterion.weight;
    });
    
    const totalWeight = rankingCriteria.reduce((sum, crit) => sum + parseFloat(crit.weight || 0), 0);
    if (totalWeight === 0) return 0;

    return (totalScore / totalWeight) * 100;
  }, [rankingCriteria]);

  // --- Data Handlers (CRUD) ---
  const handleSaveApplicant = async (applicantData) => {
    if (!db) return;
    const applicantsPath = `artifacts/${appId}/public/data/applicants`;
    try {
      if (editingApplicant) {
        const docRef = doc(db, applicantsPath, editingApplicant.id);
        await setDoc(docRef, applicantData, { merge: true });
      } else {
        await addDoc(collection(db, applicantsPath), applicantData);
      }
      setEditingApplicant(null);
      setShowApplicantForm(false);
    } catch (e) {
      console.error("Error saving applicant:", e);
      setError("Failed to save applicant.");
    }
  };

  const handleDeleteApplicant = async (applicantId) => {
    if (!db) return;
    const applicantsPath = `artifacts/${appId}/public/data/applicants`;
    try {
      await deleteDoc(doc(db, applicantsPath, applicantId));
    } catch (e) {
        console.error("Error deleting applicant:", e);
        setError("Failed to delete applicant.");
    }
  };

  const handleEditApplicant = (applicant) => {
    setEditingApplicant(applicant);
    setShowApplicantForm(true);
  };

  const handleUpdateCriteria = async (updatedCriteria) => {
    if (!db) return;
    const criteriaPath = `artifacts/${appId}/public/data/criteria`;
    const totalWeight = updatedCriteria.reduce((sum, crit) => sum + parseFloat(crit.weight || 0), 0);
    if (Math.abs(totalWeight - 1.0) > 0.01 && updatedCriteria.length > 0) {
      console.warn(`Total weights should sum to 1.00. Current sum: ${totalWeight.toFixed(2)}.`);
    }
    try {
        const batch = writeBatch(db);
        updatedCriteria.forEach(crit => {
            const docRef = doc(db, criteriaPath, crit.id);
            batch.set(docRef, crit);
        });
        await batch.commit();
    } catch (e) {
        console.error("Error updating criteria:", e);
        setError("Failed to update criteria.");
    }
  };

  const rankedApplicants = applicants
    .map(applicant => ({
      ...applicant,
      score: calculateScore(applicant),
    }))
    .filter(applicant => applicant.name.toLowerCase().includes(searchTerm.toLowerCase()))
    .sort((a, b) => b.score - a.score);

  // --- Render Logic ---
  if (error) {
    return <div className="min-h-screen bg-red-50 flex items-center justify-center p-4"><div className="bg-white p-8 rounded-lg shadow-xl text-center"><h2 className="text-2xl font-bold text-red-700 mb-4">An Error Occurred</h2><p className="text-red-600">{error}</p></div></div>;
  }

  if (isLoading) {
    return <div className="min-h-screen bg-slate-100 flex items-center justify-center"><Loader2 size={48} className="text-blue-500" /></div>;
  }
  
  const Section = ({ title, children, isOpen, onToggle }) => (
    <div className="mb-6 bg-white shadow-lg rounded-lg overflow-hidden">
      <button onClick={onToggle} className="w-full p-4 text-left bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center transition-colors duration-150">
        <h2 className="text-xl font-semibold text-gray-700">{title}</h2>
        {isOpen ? <ChevronUp className="h-6 w-6 text-gray-600" /> : <ChevronDown className="h-6 w-6 text-gray-600" />}
      </button>
      {isOpen && <div className="p-4 border-t border-gray-200">{children}</div>}
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 to-sky-100 p-4 sm:p-6 md:p-8 font-sans">
      <header className="mb-8 text-center">
        <h1 className="text-4xl font-bold text-slate-700">Applicant Ranking System</h1>
        <p className="text-slate-500 mt-2">Efficiently compare and rank job candidates.</p>
        {userId && (
            <div className="mt-4 inline-flex items-center bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                <Users size={14} className="mr-2"/>
                <span className="mr-1 font-normal">User ID:</span> {userId}
            </div>
        )}
      </header>

      <div className="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <button onClick={() => { setEditingApplicant(null); setShowApplicantForm(true); }} className="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
          <PlusCircle className="h-5 w-5 mr-2" /> Add New Applicant
        </button>
        <input type="text" placeholder="Search applicants by name..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto" />
      </div>
      
      {showApplicantForm && (
        <ApplicantForm
          applicant={editingApplicant}
          onSave={handleSaveApplicant}
          onClose={() => { setShowApplicantForm(false); setEditingApplicant(null); }}
          criteria={rankingCriteria}
        />
      )}

      <Section title="Configuration Panel" isOpen={showCriteriaConfig} onToggle={() => setShowCriteriaConfig(!showCriteriaConfig)}>
        <CriteriaConfiguration criteria={rankingCriteria} onUpdateCriteria={handleUpdateCriteria} />
      </Section>

      <div className="bg-white shadow-xl rounded-lg overflow-hidden">
        <div className="p-4 bg-gray-50 border-b border-gray-200">
          <h2 className="text-2xl font-semibold text-gray-700">Ranked Applicants</h2>
          {rankedApplicants.length === 0 && <p className="text-gray-500 mt-2">No applicants found or matching search.</p>}
        </div>
        {rankedApplicants.length > 0 && (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Email</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {rankedApplicants.map((applicant, index) => (
                  <ApplicantCard key={applicant.id} applicant={applicant} rank={index + 1} onEdit={handleEditApplicant} onDelete={handleDeleteApplicant} criteria={rankingCriteria} />
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
      <footer className="mt-12 text-center text-sm text-slate-500">
        <p>Applicant Ranking System &copy; {new Date().getFullYear()}</p>
      </footer>
    </div>
  );
}

// --- Applicant Form Component (Modal) ---
function ApplicantForm({ applicant, onSave, onClose, criteria }) {
  const [formData, setFormData] = useState({});
  const [pastedAppText, setPastedAppText] = useState('');
  const [isAiProcessing, setIsAiProcessing] = useState(false);
  const [aiError, setAiError] = useState('');
  const [apiKey, setApiKey] = useState('');
  const [showApiKeyInput, setShowApiKeyInput] = useState(false);

  useEffect(() => {
    const initialData = { name: '', email: '', notes: '' };
    criteria.forEach(crit => {
      if (crit.id === 'educationLevel') {
        initialData[crit.id] = educationLevels[0];
      } else if (crit.type.includes('numeric')) {
        initialData[crit.id] = 0;
      } else if (crit.type === 'categorical_map' && crit.map) {
        initialData[crit.id] = Object.keys(crit.map)[0] || '';
      }
    });
    setFormData(applicant ? { ...initialData, ...applicant } : initialData);
  }, [applicant, criteria]);

  const handleChange = (e) => {
    const { name, value, type } = e.target;
    setFormData(prev => ({ ...prev, [name]: type === 'number' ? parseFloat(value) : value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  // --- AI Autofill with Gemini (Simulated Cloud Function) ---
  const handleAiAutofill = async () => {
    if (!pastedAppText.trim()) {
      setAiError("Please paste the application text first.");
      return;
    }
    if (!apiKey) {
      setShowApiKeyInput(true);
      setAiError("A Gemini API Key is required for this feature.");
      return;
    }
    
    setIsAiProcessing(true);
    setAiError('');
    
    // This simulates calling a secure Firebase Cloud Function.
    // In a real deployment, the API key would NOT be here on the client.
    const prompt = `You are an expert HR assistant... Extract information from the following text into a JSON object.
      Application Text: --- ${pastedAppText} ---
      Desired JSON Output Structure: { "name": "...", "email": "...", "skillsScore": number, "yearsExperience": number, "educationLevel": "(${educationLevels.join(', ')})", "notes": "..." }`;
      
    const generationConfig = {
      responseMimeType: "application/json",
      responseSchema: {
        type: "OBJECT",
        properties: {
          "name": { "type": "STRING" }, "email": { "type": "STRING" },
          "skillsScore": { "type": "NUMBER" }, "yearsExperience": { "type": "NUMBER" },
          "educationLevel": { "type": "STRING", "enum": educationLevels },
          "notes": { "type": "STRING" }
        },
        required: ["name", "email", "notes", "skillsScore", "yearsExperience", "educationLevel"]
      }
    };

    try {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
      const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig };
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData?.error?.message || `API request failed with status ${response.status}`);
      }
      
      const result = await response.json();
      const aiJsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!aiJsonText) throw new Error("AI returned an unexpected data structure.");

      const extractedData = JSON.parse(aiJsonText);
      setFormData(prev => ({
        ...prev,
        name: extractedData.name || prev.name,
        email: extractedData.email || prev.email,
        skillsScore: parseFloat(extractedData.skillsScore) || 0,
        yearsExperience: parseFloat(extractedData.yearsExperience) || 0,
        educationLevel: educationLevels.includes(extractedData.educationLevel) ? extractedData.educationLevel : prev.educationLevel,
        notes: extractedData.notes || prev.notes,
      }));
      setPastedAppText('');
    } catch (error) {
      console.error("Error during AI autofill:", error);
      setAiError(`Failed to process with AI: ${error.message}. Please check your API key and try again.`);
      setShowApiKeyInput(true);
    } finally {
      setIsAiProcessing(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
      <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-semibold text-gray-700">{applicant ? 'Edit Applicant' : 'Add New Applicant'}</h3>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700"><XCircle size={24} /></button>
        </div>

        <div className="mb-6 p-4 border border-dashed border-sky-400 rounded-lg bg-sky-50">
          <label htmlFor="pastedAppText" className="block text-sm font-medium text-sky-700 mb-1">Paste Application Text for AI Autofill:</label>
          <textarea id="pastedAppText" rows="5" value={pastedAppText} onChange={(e) => setPastedAppText(e.target.value)} placeholder="Copy and paste a resume or application text here..." className="mt-1 block w-full px-3 py-2 border border-sky-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" disabled={isAiProcessing} />
          <button type="button" onClick={handleAiAutofill} disabled={isAiProcessing || !pastedAppText.trim()} className="mt-2 w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 border border-transparent rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:bg-gray-400">
            {isAiProcessing ? <Loader2 className="h-5 w-5 mr-2" /> : <Zap className="h-5 w-5 mr-2" />}
            {isAiProcessing ? 'Processing...' : 'Autofill with AI'}
          </button>
          {aiError && <p className="mt-2 text-xs text-red-600">{aiError}</p>}
          {showApiKeyInput && (
            <div className="mt-3 p-3 border border-amber-400 bg-amber-50 rounded-md">
                <label htmlFor="apiKeyInput" className="block text-xs font-medium text-amber-700">Enter your Gemini API Key:</label>
                <div className="flex items-center mt-1">
                    <KeyRound className="h-4 w-4 mr-2 text-amber-600" />
                    <input type="password" id="apiKeyInput" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Your API key is stored locally" className="flex-grow px-2 py-1 border border-amber-300 rounded-l-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-xs" />
                    <button type="button" onClick={() => setShowApiKeyInput(false)} className="px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white text-xs font-medium rounded-r-md border border-amber-500">Save</button>
                </div>
            </div>
          )}
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="name" className="block text-sm font-medium text-gray-700">Full Name</label>
            <input type="text" name="name" id="name" value={formData.name || ''} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
          </div>
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="email" id="email" value={formData.email || ''} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
          </div>

          {criteria.map(crit => {
            if (crit.id === 'educationLevel') {
              return (
                <div key={crit.id}>
                  <label htmlFor={crit.id} className="block text-sm font-medium text-gray-700">{crit.name}</label>
                  <select name={crit.id} id={crit.id} value={formData[crit.id] || educationLevels[0]} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    {educationLevels.map(level => <option key={level} value={level}>{level}</option>)}
                  </select>
                </div>
              );
            }
            if (crit.type.includes('numeric')) {
              const maxVal = crit.type === 'numeric' ? crit.maxScore : 50;
              const stepVal = crit.type === 'numeric_map' ? 0.5 : 1;
              return (
                <div key={crit.id}>
                  <label htmlFor={crit.id} className="block text-sm font-medium text-gray-700">{crit.name}</label>
                  <input type="number" name={crit.id} id={crit.id} value={formData[crit.id] || 0} onChange={handleChange} min="0" max={maxVal} step={stepVal} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                </div>
              );
            }
            return null;
          })}
          <div>
            <label htmlFor="notes" className="block text-sm font-medium text-gray-700">Notes/Summary</label>
            <textarea name="notes" id="notes" value={formData.notes || ''} onChange={handleChange} rows="3" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
          </div>

          <div className="flex justify-end space-x-3 pt-2">
            <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-md shadow-sm">Cancel</button>
            <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">
              <Save className="inline h-4 w-4 mr-1" /> {applicant ? 'Update' : 'Save'} Applicant
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// --- Criteria Configuration Component ---
function CriteriaConfiguration({ criteria, onUpdateCriteria }) {
  const [localCriteria, setLocalCriteria] = useState([]);

  useEffect(() => {
    setLocalCriteria(JSON.parse(JSON.stringify(criteria)));
  }, [criteria]);

  const handleCritChange = (index, field, value) => {
    const updated = [...localCriteria];
    if (field === 'weight' || field === 'maxScore') {
      updated[index][field] = parseFloat(value) || 0;
    } else {
      updated[index][field] = value;
    }
    setLocalCriteria(updated);
  };
  
  const handleSaveCriteria = () => {
    onUpdateCriteria(localCriteria);
  };

  const addCriterion = () => {
    setLocalCriteria([...localCriteria, { id: generateId(), name: 'New Criterion', weight: 0.1, type: 'numeric', maxScore: 10 }]);
  };

  const removeCriterion = (idToRemove) => {
    const updated = localCriteria.filter((crit) => crit.id !== idToRemove);
    setLocalCriteria(updated);
    // Note: This only removes from local state. Saving will sync deletion with Firestore.
  };

  const totalWeight = localCriteria.reduce((sum, crit) => sum + parseFloat(crit.weight || 0), 0);

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-medium text-gray-800">Define Ranking Criteria & Weights</h3>
        <button onClick={addCriterion} className="flex items-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg shadow text-sm">
          <PlusCircle size={18} className="mr-1" /> Add Criterion
        </button>
      </div>
      <div className="space-y-4">
        {localCriteria.map((crit, index) => (
          <div key={crit.id} className="p-3 border border-gray-200 rounded-md bg-gray-50 grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
            <input type="text" value={crit.name} onChange={(e) => handleCritChange(index, 'name', e.target.value)} placeholder="Criterion Name" className="md:col-span-4 p-2 border border-gray-300 rounded-md text-sm" />
            <select value={crit.type} onChange={(e) => handleCritChange(index, 'type', e.target.value)} className="md:col-span-3 p-2 border border-gray-300 rounded-md text-sm">
              <option value="numeric">Numeric Score (0-Max)</option>
              <option value="categorical_map">Category Map (predefined)</option>
              <option value="numeric_map">Numeric Range Map (predefined)</option>
            </select>
            <input type="number" value={crit.weight} onChange={(e) => handleCritChange(index, 'weight', e.target.value)} placeholder="Weight" step="0.01" min="0" max="1" className="md:col-span-2 p-2 border border-gray-300 rounded-md text-sm" />
            <input type="number" value={crit.maxScore} onChange={(e) => handleCritChange(index, 'maxScore', e.target.value)} placeholder="Max Score" step="1" min="0" className="md:col-span-2 p-2 border border-gray-300 rounded-md text-sm" title="Max possible score for normalization" />
            <button onClick={() => removeCriterion(crit.id)} className="md:col-span-1 text-red-500 hover:text-red-700 flex justify-center items-center">
              <Trash2 size={18} />
            </button>
          </div>
        ))}
      </div>
      <div className="mt-4 flex justify-between items-center">
        <p className={`text-sm ${Math.abs(totalWeight - 1.0) > 0.01 && localCriteria.length > 0 ? 'text-red-600 font-semibold' : 'text-gray-600'}`}>
          Total Weight: {totalWeight.toFixed(2)} (Should be 1.00)
        </p>
        <button onClick={handleSaveCriteria} className="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm">
          <Save size={18} className="mr-2" /> Save Criteria
        </button>
      </div>
    </div>
  );
}

// --- Applicant Card Component (Table Row) ---
function ApplicantCard({ applicant, rank, onEdit, onDelete, criteria }) {
  const [expanded, setExpanded] = useState(false);

  const getCriterionValueDisplay = (applicant, criterion) => {
    const value = applicant[criterion.id];
    if (value === undefined || value === null) return 'N/A';
    if (typeof value === 'number') return value.toFixed(1);
    return String(value);
  };

  return (
    <>
      <tr className={`hover:bg-sky-50 transition-colors duration-150 ${expanded ? 'bg-sky-50' : ''}`}>
        <td className="px-4 py-3 whitespace-nowrap">
          <span className={`inline-block text-sm font-semibold px-2 py-1 rounded-full ${rank === 1 ? 'bg-green-100 text-green-700' : rank === 2 ? 'bg-yellow-100 text-yellow-700' : rank === 3 ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'}`}>
            #{rank}
          </span>
        </td>
        <td className="px-4 py-3 whitespace-nowrap"><div className="text-sm font-medium text-gray-900">{applicant.name}</div></td>
        <td className="px-4 py-3 whitespace-nowrap hidden sm:table-cell"><div className="text-sm text-gray-500">{applicant.email}</div></td>
        <td className="px-4 py-3 whitespace-nowrap"><div className="text-sm font-bold text-blue-600">{applicant.score.toFixed(2)}</div></td>
        <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
          <button onClick={() => setExpanded(!expanded)} className="text-indigo-600 hover:text-indigo-900 mr-2 p-1"><ChevronDown size={18} /></button>
          <button onClick={() => onEdit(applicant)} className="text-blue-600 hover:text-blue-900 mr-2 p-1"><Edit2 size={18} /></button>
          <button onClick={() => onDelete(applicant.id)} className="text-red-600 hover:text-red-900 p-1"><Trash2 size={18} /></button>
        </td>
      </tr>
      {expanded && (
        <tr className="bg-slate-50">
          <td colSpan="5" className="px-4 py-3">
            <div className="text-sm text-gray-700 space-y-2">
              <p><strong>Notes:</strong> {applicant.notes || 'N/A'}</p>
              <div className="mt-2 pt-2 border-t">
                <h4 className="font-semibold mb-1">Score Inputs:</h4>
                <ul className="list-disc list-inside pl-2 space-y-0.5 text-xs">
                  {criteria.map(crit => (
                    <li key={crit.id}>
                      {crit.name}: {getCriterionValueDisplay(applicant, crit)} ({(crit.weight*100).toFixed(0)}% weight)
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </td>
        </tr>
      )}
    </>
  );
}

export default App;
