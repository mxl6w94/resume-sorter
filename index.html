const handleAiAutofill = async () => {
            const apiKey = document.getElementById('apiKeyInput').value;
            const aiErrorEl = document.getElementById('ai-error');
            const apiKeyContainer = document.getElementById('api-key-input-container');

            if (!extractedFileText.trim()) {
                aiErrorEl.textContent = "Please upload and parse a file first."; return;
            }
            if (!apiKey) {
                apiKeyContainer.classList.remove('hidden');
                aiErrorEl.textContent = "A Gemini API Key is required for this feature."; return;
            }
            
            const autofillBtn = document.getElementById('ai-autofill-btn');
            autofillBtn.disabled = true;
            autofillBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg> Processing...`;
            aiErrorEl.textContent = '';
            
            const aiCriteria = rankingCriteria.filter(c => c.isAiPowered);
            const schemaProperties = {
                "name": { "type": "STRING", "description": "The full name of the candidate." },
                "email": { "type": "STRING", "description": "The email address of the candidate." },
                "notes": { "type": "STRING", "description": "A brief 2-3 sentence summary of the candidate's key qualifications from the resume." }
            };
            const requiredFields = ["name", "email", "notes"];

            const dynamicPrompts = aiCriteria
                .map(c => {
                    let instruction = '';
                    let propertyDefined = false;

                    switch (c.type) {
                        case 'numeric':
                            schemaProperties[c.id] = { "type": "NUMBER", "description": c.aiPrompt };
                            instruction = `A number from ${c.min || 0} to ${c.max || 10} based on this instruction: ${c.aiPrompt}`;
                            propertyDefined = true;
                            break;
                        case 'yes_no':
                            schemaProperties[c.id] = { "type": "STRING", "enum": ["Yes", "No"], "description": c.aiPrompt };
                            instruction = `Answer 'Yes' or 'No' based on this instruction: ${c.aiPrompt}`;
                            propertyDefined = true;
                            break;
                        case 'tiered':
                            // Ensure tiers exist and are not empty before creating the schema property.
                            if (c.tiers && c.tiers.length > 0) {
                                const levels = c.tiers.map(t => t.level).filter(Boolean); // Filter out any null/empty strings
                                if (levels.length > 0) {
                                    schemaProperties[c.id] = { "type": "STRING", "enum": levels, "description": c.aiPrompt };
                                    instruction = `Choose one of these options [${levels.join(', ')}] based on this instruction: ${c.aiPrompt}`;
                                    propertyDefined = true;
                                }
                            }
                            break;
                    }

                    if (propertyDefined) {
                        requiredFields.push(c.id);
                        // Return the prompt part for this criterion.
                        return `"${c.id}": "${instruction.replace(/"/g, '\\"')}"`; // Escape quotes in instruction
                    }
                    return null; // Return null for invalid criteria to be filtered out.
                })
                .filter(Boolean) // Remove null entries
                .join(',\n');
            
            const prompt = `You are an expert HR assistant. Based on the following resume text, extract the candidate's information. Format the output as a JSON object.

Resume Text: ---
${extractedFileText}
---

Desired JSON Output Structure:
{
    "name": "Candidate's full name",
    "email": "Candidate's email address",
    "notes": "A brief 2-3 sentence summary of key qualifications.",
    ${dynamicPrompts}
}`;
            
            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: schemaProperties,
              _message_too_long
